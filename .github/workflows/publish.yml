---
name: Publish

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

concurrency:
  # only run one publishing at a time to avoid conflicts
  group: publish-${{ github.ref }}

jobs:
  publish:
    # Only on main repository (no publishing on forks)
    if: github.repository_owner == 'halestudio'

    uses: wetransform/gha-workflows/.github/workflows/gradle-library-publish.yml@cabfc6b25aedd97f169788a9cf84a62b9e963e15 # v3.8.2
    with:
      java-version: 17
      multi-module: true
      skip-scan: true
      build-tasks: '--continue clean spotlessCheck check :allure:allureAggreggateResults'
      upload-artifact-path: allure/build/allure-results
      upload-artifact-name: allure-results
    secrets:
      WETF_ARTIFACTORY_USER: ${{ secrets.WETF_ARTIFACTORY_USER }}
      WETF_ARTIFACTORY_PASSWORD: ${{ secrets.WETF_ARTIFACTORY_PASSWORD }}
      SLACK_NOTIFICATIONS_BOT_TOKEN: ${{ secrets.SLACK_NOTIFICATIONS_BOT_TOKEN }}

  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Vulnerability scan
        uses: ./.github/scan

  allure:
    # https://allurereport.org/docs/integrations-github/
    runs-on: ubuntu-latest
    if: always() # even if tests fail
    needs: publish

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download artifact from build
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: allure-results
          path: allure-results

      - name: Load test report history
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build test report
        uses: simple-elf/allure-report-action@58e6590adf6d8f196a0d771bf8a00e6921086a62 # v1.9
        with:
          gh_pages: gh-pages
          allure_history: allure-history
          allure_results: allure-results

      - name: Publish test report
        uses: JamesIves/github-pages-deploy-action@4a3abc783e1a24aeb44c16e869ad83caf6b4cc23 # v4.7.4
        with:
          branch: gh-pages
          folder: allure-history
          clean-exclude: pr-preview/
          force: false
